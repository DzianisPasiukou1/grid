<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: ext-d3-sankey/ext-d3-sankey.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: ext-d3-sankey/ext-d3-sankey.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>(function () {
	'use strict';

	angular
		.module('ext.common.d3Sankey')
		.run(d3Sankey);

	d3Sankey.$inject = [];

	/**
	 * Description
	 * @method d3Sankey
	 * @return 
	 */
	function d3Sankey() {
		/**
		 * Description
		 * @method sankey
		 * @return sankey
		 */
		d3.sankey = function () {
			var sankey = {},
				nodeWidth = 24,
				nodePadding = 8,
				size = [1, 1],
				nodes = [],
				links = [];

			/**
			 * Description
			 * @method nodeWidth
			 * @param {} _
			 * @return sankey
			 */
			sankey.nodeWidth = function (_) {
				if (!arguments.length) return nodeWidth;
				nodeWidth = +_;
				return sankey;
			};

			/**
			 * Description
			 * @method nodePadding
			 * @param {} _
			 * @return sankey
			 */
			sankey.nodePadding = function (_) {
				if (!arguments.length) return nodePadding;
				nodePadding = +_;
				return sankey;
			};

			/**
			 * Description
			 * @method nodes
			 * @param {} _
			 * @return sankey
			 */
			sankey.nodes = function (_) {
				if (!arguments.length) return nodes;
				nodes = _;
				return sankey;
			};

			/**
			 * Description
			 * @method links
			 * @param {} _
			 * @return sankey
			 */
			sankey.links = function (_) {
				if (!arguments.length) return links;
				links = _;
				return sankey;
			};

			/**
			 * Description
			 * @method size
			 * @param {} _
			 * @return sankey
			 */
			sankey.size = function (_) {
				if (!arguments.length) return size;
				size = _;
				return sankey;
			};

			/**
			 * Description
			 * @method layout
			 * @param {} iterations
			 * @return sankey
			 */
			sankey.layout = function (iterations) {
				computeNodeLinks();
				computeNodeValues();
				computeNodeBreadths();
				computeNodeDepths(iterations);
				computeLinkDepths();
				return sankey;
			};

			/**
			 * Description
			 * @method relayout
			 * @return sankey
			 */
			sankey.relayout = function () {
				computeLinkDepths();
				return sankey;
			};

			/**
			 * Description
			 * @method link
			 * @return link
			 */
			sankey.link = function () {
				var curvature = .5;

				/**
				 * Description
				 * @method link
				 * @param {} d
				 * @return BinaryExpression
				 */
				function link(d) {
					var x0 = d.source.x + d.source.dx,
						x1 = d.target.x,
						xi = d3.interpolateNumber(x0, x1),
						x2 = xi(curvature),
						x3 = xi(1 - curvature),
						y0 = d.source.y + d.sy + d.dy / 2,
						y1 = d.target.y + d.ty + d.dy / 2;
					return "M" + x0 + "," + y0
						+ "C" + x2 + "," + y0
						+ " " + x3 + "," + y1
						+ " " + x1 + "," + y1;
				}

				/**
				 * Description
				 * @method curvature
				 * @param {} _
				 * @return link
				 */
				link.curvature = function (_) {
					if (!arguments.length) return curvature;
					curvature = +_;
					return link;
				};

				return link;
			};

			// Populate the sourceLinks and targetLinks for each node.
			// Also, if the source and target are not objects, assume they are indices.
			/**
			 * Description
			 * @method computeNodeLinks
			 * @return 
			 */
			function computeNodeLinks() {
				nodes.forEach(function (node) {
					node.sourceLinks = [];
					node.targetLinks = [];
				});
				links.forEach(function (link) {
					var source = link.source,
						target = link.target;
					if (typeof source === "number") source = link.source = nodes[link.source];
					if (typeof target === "number") target = link.target = nodes[link.target];
					source.sourceLinks.push(link);
					target.targetLinks.push(link);
				});
			}

			// Compute the value (size) of each node by summing the associated links.
			/**
			 * Description
			 * @method computeNodeValues
			 * @return 
			 */
			function computeNodeValues() {
				nodes.forEach(function (node) {
					node.value = Math.max(
						d3.sum(node.sourceLinks, value),
						d3.sum(node.targetLinks, value)
						);
				});
			}

			// Iteratively assign the breadth (x-position) for each node.
			// Nodes are assigned the maximum breadth of incoming neighbors plus one;
			// nodes with no incoming links are assigned breadth zero, while
			// nodes with no outgoing links are assigned the maximum breadth.
			/**
			 * Description
			 * @method computeNodeBreadths
			 * @return 
			 */
			function computeNodeBreadths() {
				var remainingNodes = nodes,
					nextNodes,
					x = 0;

				while (remainingNodes.length) {
					nextNodes = [];
					remainingNodes.forEach(function (node) {
						node.x = x;
						node.dx = nodeWidth;
						node.sourceLinks.forEach(function (link) {
							nextNodes.push(link.target);
						});
					});
					remainingNodes = nextNodes;
					++x;
				}

				//
				moveSinksRight(x);
				scaleNodeBreadths((size[0] - nodeWidth) / (x - 1));
			}

			/**
			 * Description
			 * @method moveSourcesRight
			 * @return 
			 */
			function moveSourcesRight() {
				nodes.forEach(function (node) {
					if (!node.targetLinks.length) {
						node.x = d3.min(node.sourceLinks, function (d) { return d.target.x; }) - 1;
					}
				});
			}

			/**
			 * Description
			 * @method moveSinksRight
			 * @param {} x
			 * @return 
			 */
			function moveSinksRight(x) {
				nodes.forEach(function (node) {
					if (!node.sourceLinks.length) {
						node.x = x - 1;
					}
				});
			}

			/**
			 * Description
			 * @method scaleNodeBreadths
			 * @param {} kx
			 * @return 
			 */
			function scaleNodeBreadths(kx) {
				nodes.forEach(function (node) {
					node.x *= kx;
				});
			}

			/**
			 * Description
			 * @method computeNodeDepths
			 * @param {} iterations
			 * @return 
			 */
			function computeNodeDepths(iterations) {
				var nodesByBreadth = d3.nest()
					.key(function (d) { return d.x; })
					.sortKeys(d3.ascending)
					.entries(nodes)
					.map(function (d) { return d.values; });

				//
				initializeNodeDepth();
				resolveCollisions();
				for (var alpha = 1; iterations > 0; --iterations) {
					relaxRightToLeft(alpha *= .99);
					resolveCollisions();
					relaxLeftToRight(alpha);
					resolveCollisions();
				}

				/**
				 * Description
				 * @method initializeNodeDepth
				 * @return 
				 */
				function initializeNodeDepth() {
					var ky = d3.min(nodesByBreadth, function (nodes) {
						return (size[1] - (nodes.length - 1) * nodePadding) / d3.sum(nodes, value);
					});

					nodesByBreadth.forEach(function (nodes) {
						nodes.forEach(function (node, i) {
							node.y = i;
							node.dy = node.value * ky;
						});
					});

					links.forEach(function (link) {
						link.dy = link.value * ky;
					});
				}

				/**
				 * Description
				 * @method relaxLeftToRight
				 * @param {} alpha
				 * @return 
				 */
				function relaxLeftToRight(alpha) {
					nodesByBreadth.forEach(function (nodes, breadth) {
						nodes.forEach(function (node) {
							if (node.targetLinks.length) {
								var y = d3.sum(node.targetLinks, weightedSource) / d3.sum(node.targetLinks, value);
								node.y += (y - center(node)) * alpha;
							}
						});
					});

					/**
					 * Description
					 * @method weightedSource
					 * @param {} link
					 * @return BinaryExpression
					 */
					function weightedSource(link) {
						return center(link.source) * link.value;
					}
				}

				/**
				 * Description
				 * @method relaxRightToLeft
				 * @param {} alpha
				 * @return 
				 */
				function relaxRightToLeft(alpha) {
					nodesByBreadth.slice().reverse().forEach(function (nodes) {
						nodes.forEach(function (node) {
							if (node.sourceLinks.length) {
								var y = d3.sum(node.sourceLinks, weightedTarget) / d3.sum(node.sourceLinks, value);
								node.y += (y - center(node)) * alpha;
							}
						});
					});

					/**
					 * Description
					 * @method weightedTarget
					 * @param {} link
					 * @return BinaryExpression
					 */
					function weightedTarget(link) {
						return center(link.target) * link.value;
					}
				}

				/**
				 * Description
				 * @method resolveCollisions
				 * @return 
				 */
				function resolveCollisions() {
					nodesByBreadth.forEach(function (nodes) {
						var node,
							dy,
							y0 = 0,
							n = nodes.length,
							i;

						// Push any overlapping nodes down.
						nodes.sort(ascendingDepth);
						for (i = 0; i &lt; n; ++i) {
							node = nodes[i];
							dy = y0 - node.y;
							if (dy > 0) node.y += dy;
							y0 = node.y + node.dy + nodePadding;
						}

						// If the bottommost node goes outside the bounds, push it back up.
						dy = y0 - nodePadding - size[1];
						if (dy > 0) {
							y0 = node.y -= dy;

							// Push any overlapping nodes back up.
							for (i = n - 2; i >= 0; --i) {
								node = nodes[i];
								dy = node.y + node.dy + nodePadding - y0;
								if (dy > 0) node.y -= dy;
								y0 = node.y;
							}
						}
					});
				}

				/**
				 * Description
				 * @method ascendingDepth
				 * @param {} a
				 * @param {} b
				 * @return BinaryExpression
				 */
				function ascendingDepth(a, b) {
					return a.y - b.y;
				}
			}

			/**
			 * Description
			 * @method computeLinkDepths
			 * @return 
			 */
			function computeLinkDepths() {
				nodes.forEach(function (node) {
					node.sourceLinks.sort(ascendingTargetDepth);
					node.targetLinks.sort(ascendingSourceDepth);
				});
				nodes.forEach(function (node) {
					var sy = 0, ty = 0;
					node.sourceLinks.forEach(function (link) {
						link.sy = sy;
						sy += link.dy;
					});
					node.targetLinks.forEach(function (link) {
						link.ty = ty;
						ty += link.dy;
					});
				});

				/**
				 * Description
				 * @method ascendingSourceDepth
				 * @param {} a
				 * @param {} b
				 * @return BinaryExpression
				 */
				function ascendingSourceDepth(a, b) {
					return a.source.y - b.source.y;
				}

				/**
				 * Description
				 * @method ascendingTargetDepth
				 * @param {} a
				 * @param {} b
				 * @return BinaryExpression
				 */
				function ascendingTargetDepth(a, b) {
					return a.target.y - b.target.y;
				}
			}

			/**
			 * Description
			 * @method center
			 * @param {} node
			 * @return BinaryExpression
			 */
			function center(node) {
				return node.y + node.dy / 2;
			}

			/**
			 * Description
			 * @method value
			 * @param {} link
			 * @return MemberExpression
			 */
			function value(link) {
				return link.value;
			}

			return sankey;
		};
	};
} ());</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Namespaces</h3><ul><li><a href="global.html#anyOtherClick">anyOtherClick</a></li></ul><h3>Global</h3><ul><li><a href="global.html#anyOtherClickLink">anyOtherClickLink</a></li><li><a href="global.html#ascendingDepth">ascendingDepth</a></li><li><a href="global.html#ascendingSourceDepth">ascendingSourceDepth</a></li><li><a href="global.html#ascendingTargetDepth">ascendingTargetDepth</a></li><li><a href="global.html#calculate">calculate</a></li><li><a href="global.html#center">center</a></li><li><a href="global.html#change">change</a></li><li><a href="global.html#changedNumber">changedNumber</a></li><li><a href="global.html#clear">clear</a></li><li><a href="global.html#close">close</a></li><li><a href="global.html#compile">compile</a></li><li><a href="global.html#compilePost">compilePost</a></li><li><a href="global.html#computeLinkDepths">computeLinkDepths</a></li><li><a href="global.html#computeNodeBreadths">computeNodeBreadths</a></li><li><a href="global.html#computeNodeDepths">computeNodeDepths</a></li><li><a href="global.html#computeNodeLinks">computeNodeLinks</a></li><li><a href="global.html#computeNodeValues">computeNodeValues</a></li><li><a href="global.html#Counter">Counter</a></li><li><a href="global.html#counterFactory">counterFactory</a></li><li><a href="global.html#cursorMessage">cursorMessage</a></li><li><a href="global.html#curvature">curvature</a></li><li><a href="global.html#d3Sankey">d3Sankey</a></li><li><a href="global.html#defineObj">defineObj</a></li><li><a href="global.html#definner">definner</a></li><li><a href="global.html#destroy">destroy</a></li><li><a href="global.html#dynamic">dynamic</a></li><li><a href="global.html#event">event</a></li><li><a href="global.html#ExtContentOptionsSearchBaseController">ExtContentOptionsSearchBaseController</a></li><li><a href="global.html#extDatepicker">extDatepicker</a></li><li><a href="global.html#ExtDatepickerController">ExtDatepickerController</a></li><li><a href="global.html#extDefine">extDefine</a></li><li><a href="global.html#extDropdown">extDropdown</a></li><li><a href="global.html#ExtDropdownController">ExtDropdownController</a></li><li><a href="global.html#extDynamicDropdown">extDynamicDropdown</a></li><li><a href="global.html#extend">extend</a></li><li><a href="global.html#extExtend">extExtend</a></li><li><a href="global.html#extInitDefaultService">extInitDefaultService</a></li><li><a href="global.html#extJsonService">extJsonService</a></li><li><a href="global.html#extLoading">extLoading</a></li><li><a href="global.html#ExtLoadingController">ExtLoadingController</a></li><li><a href="global.html#extMaxHeighter">extMaxHeighter</a></li><li><a href="global.html#extNumberFormat">extNumberFormat</a></li><li><a href="global.html#extOnFinishRender">extOnFinishRender</a></li><li><a href="global.html#extResizeOn">extResizeOn</a></li><li><a href="global.html#ExtResizeOnController">ExtResizeOnController</a></li><li><a href="global.html#extSearch">extSearch</a></li><li><a href="global.html#ExtSearchController">ExtSearchController</a></li><li><a href="global.html#extSplitButton">extSplitButton</a></li><li><a href="global.html#ExtSplitButtonControler">ExtSplitButtonControler</a></li><li><a href="global.html#extUpload">extUpload</a></li><li><a href="global.html#ExtUploadController">ExtUploadController</a></li><li><a href="global.html#extWindow">extWindow</a></li><li><a href="global.html#fileChange">fileChange</a></li><li><a href="global.html#get">get</a></li><li><a href="global.html#getCounter">getCounter</a></li><li><a href="global.html#getOrigWindow">getOrigWindow</a></li><li><a href="global.html#grTemplate">grTemplate</a></li><li><a href="global.html#grTemplateService">grTemplateService</a></li><li><a href="global.html#height">height</a></li><li><a href="global.html#hideCursorMessage">hideCursorMessage</a></li><li><a href="global.html#init">init</a></li><li><a href="global.html#initializeNodeDepth">initializeNodeDepth</a></li><li><a href="global.html#layout">layout</a></li><li><a href="global.html#link">link</a></li><li><a href="global.html#links">links</a></li><li><a href="global.html#loggerService">loggerService</a></li><li><a href="global.html#moveSinksRight">moveSinksRight</a></li><li><a href="global.html#moveSourcesRight">moveSourcesRight</a></li><li><a href="global.html#nFormatter">nFormatter</a></li><li><a href="global.html#nodePadding">nodePadding</a></li><li><a href="global.html#nodes">nodes</a></li><li><a href="global.html#nodeWidth">nodeWidth</a></li><li><a href="global.html#onloadend">onloadend</a></li><li><a href="global.html#onPositionChanged">onPositionChanged</a></li><li><a href="global.html#put">put</a></li><li><a href="global.html#relaxLeftToRight">relaxLeftToRight</a></li><li><a href="global.html#relaxRightToLeft">relaxRightToLeft</a></li><li><a href="global.html#relayout">relayout</a></li><li><a href="global.html#resize">resize</a></li><li><a href="global.html#resizeOn">resizeOn</a></li><li><a href="global.html#resolveCollisions">resolveCollisions</a></li><li><a href="global.html#sankey">sankey</a></li><li><a href="global.html#scaleNodeBreadths">scaleNodeBreadths</a></li><li><a href="global.html#searchValueChanged">searchValueChanged</a></li><li><a href="global.html#select">select</a></li><li><a href="global.html#size">size</a></li><li><a href="global.html#toggle">toggle</a></li><li><a href="global.html#toggleVisible">toggleVisible</a></li><li><a href="global.html#undynamic">undynamic</a></li><li><a href="global.html#value">value</a></li><li><a href="global.html#weightedSource">weightedSource</a></li><li><a href="global.html#weightedTarget">weightedTarget</a></li><li><a href="global.html#width">width</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.3.2</a> on Thu Sep 10 2015 16:54:07 GMT+0300 (Belarus Standard Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
